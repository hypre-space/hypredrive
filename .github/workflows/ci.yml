name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'NOTICE'
      - 'COPYRIGHT'
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'NOTICE'
      - 'COPYRIGHT'
  workflow_dispatch:    # Allow manual triggering

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    if: ${{ github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'Run CI') }}
    name: ${{ matrix.os }} | ${{ matrix.compiler }} | ${{ matrix.build_type }} | ${{ matrix.hypre_version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Debug]
        compiler: [gcc, clang]
        hypre_version: [master, v3.1.0, v2.20.0]
        exclude:
          - os: macos-latest
            compiler: gcc
    env:
      HYPRE_VERSION: ${{ matrix.hypre_version }}
      BUILD_DIR: build
    steps:
      - uses: actions/checkout@v6

      - name: Get compiler version
        id: compiler_version
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            VERSION=$(gcc --version 2>/dev/null | head -n1 | awk '{print $NF}' || echo "unknown")
          else
            VERSION=$(clang --version 2>/dev/null | head -n1 | awk -F'version ' '{print $2}' | awk '{print $1}' || echo "unknown")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Compiler version: $VERSION"
          echo "::notice::Building with ${{ matrix.compiler }} version $VERSION"

      - name: Install dependencies (Ubuntu)
        if: startsWith(runner.os, 'Linux')
        run: |
          sudo apt-get update
          # Install OpenMPI instead of MPICH for better CI compatibility
          sudo apt-get install -y cmake ninja-build libopenmpi-dev openmpi-bin ccache clang-format
          if [ "${{ matrix.compiler }}" = "gcc" ]; then sudo apt-get install -y gcc g++; fi
          if [ "${{ matrix.compiler }}" = "clang" ]; then sudo apt-get install -y clang; fi
          # Get and display compiler version
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            VERSION=$(gcc --version | head -n1 | awk '{print $NF}')
          else
            VERSION=$(clang --version | head -n1 | awk -F'version ' '{print $2}' | awk '{print $1}')
          fi
          echo "::notice::Using ${{ matrix.compiler }} version $VERSION"

      - name: Setup compiler environment (Ubuntu)
        if: startsWith(runner.os, 'Linux')
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            # Configure mpicc to use clang
            export OMPI_CC=clang
            export OMPI_CXX=clang++
            echo "OMPI_CC=clang" >> $GITHUB_ENV
            echo "OMPI_CXX=clang++" >> $GITHUB_ENV
          else
            # Configure mpicc to use gcc (default)
            export OMPI_CC=gcc
            export OMPI_CXX=g++
            echo "OMPI_CC=gcc" >> $GITHUB_ENV
            echo "OMPI_CXX=g++" >> $GITHUB_ENV
          fi

      - name: Setup ccache (Ubuntu)
        if: startsWith(runner.os, 'Linux')
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ runner.os }}-${{ matrix.compiler }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.compiler }}-
            ${{ runner.os }}-

      - name: Install dependencies (macOS)
        if: startsWith(runner.os, 'macOS')
        run: |
          brew update
          brew install mpich clang-format
          # Get and display compiler version
          VERSION=$(clang --version | head -n1 | awk -F'version ' '{print $2}' | awk '{print $1}')
          echo "::notice::Using clang version $VERSION"

      - name: Setup compiler environment (macOS)
        if: startsWith(runner.os, 'macOS')
        run: |
          # macOS mpicc uses clang by default (Apple Clang)
          export MPICH_CC=clang
          export MPICH_CXX=clang++
          echo "MPICH_CC=clang" >> $GITHUB_ENV
          echo "MPICH_CXX=clang++" >> $GITHUB_ENV

      - name: Cache datasets
        uses: actions/cache@v5
        with:
          path: data
          key: datasets-v1
          restore-keys: |
            datasets-v1

      - name: Build HYPRE
        id: build-hypre
        uses: ./.github/actions/build-hypre
        with:
          hypre_version: ${{ env.HYPRE_VERSION }}
          compiler: ${{ matrix.compiler }}
          build_type: 'Debug'
          hypre_shared_libs: 'ON'
          os: ${{ matrix.os }}
          mpi_flavor: ${{ startsWith(matrix.os, 'macos') && 'mpich' || 'openmpi' }}

      - name: Configure hypredrive
        run: |
          set -euxo pipefail
          CCACHE_ARGS=""
          if [ "${{ runner.os }}" = "Linux" ]; then
            CCACHE_ARGS="-DCMAKE_C_COMPILER_LAUNCHER=ccache"
          fi
          # Display compiler info in build logs
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "::notice::Configuring with gcc $(gcc --version | head -n1 | awk '{print $NF}')"
          else
            echo "::notice::Configuring with clang $(clang --version | head -n1 | awk -F'version ' '{print $2}' | awk '{print $1}')"
          fi
          HYPRE_PREFIX="${{ steps.build-hypre.outputs.hypre_prefix }}"
          HYPRE_ARGS="-DCMAKE_PREFIX_PATH=${HYPRE_PREFIX} -DHYPRE_VERSION=${{ matrix.hypre_version }}"
          if [[ "${{ matrix.hypre_version }}" =~ ^v ]] && \
             printf "%s\n" "v2.32.0" "${{ matrix.hypre_version }}" | sort -V | head -n1 | grep -q "^${{ matrix.hypre_version }}$"; then
            HYPRE_INCLUDE_DIRS="${HYPRE_PREFIX}/include"
            if [ -f "${HYPRE_PREFIX}/lib/libHYPRE.so" ]; then
              HYPRE_LIBRARIES="${HYPRE_PREFIX}/lib/libHYPRE.so"
            elif [ -f "${HYPRE_PREFIX}/lib/libHYPRE.dylib" ]; then
              HYPRE_LIBRARIES="${HYPRE_PREFIX}/lib/libHYPRE.dylib"
            else
              HYPRE_LIBRARIES="${HYPRE_PREFIX}/lib/libHYPRE.a"
            fi
            HYPRE_ARGS="${HYPRE_ARGS} -DHYPRE_INCLUDE_DIRS=${HYPRE_INCLUDE_DIRS} -DHYPRE_LIBRARIES=${HYPRE_LIBRARIES}"
          fi
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DHYPREDRV_ENABLE_TESTING=ON -DHYPREDRV_ENABLE_EXAMPLES=ON \
            -DBUILD_SHARED_LIBS=ON \
            ${HYPRE_ARGS} \
            $CCACHE_ARGS

      - name: Build
        run: cmake --build $BUILD_DIR --parallel

      - name: Fetch datasets (optional)
        run: |
          set -euxo pipefail
          # Only download if datasets are not already cached
          if [ ! -d "data/ps3d10pt7" ] || [ -z "$(ls -A data/ps3d10pt7 2>/dev/null)" ]; then
            cmake --build $BUILD_DIR --target data --parallel
          else
            echo "Datasets already cached, skipping download"
          fi

      - name: Run tests
        timeout-minutes: 5
        env:
          OMPI_ALLOW_RUN_AS_ROOT: 1
          OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
          OMPI_MCA_btl_vader_single_copy_mechanism: none
          OMPI_MCA_rmaps_base_oversubscribe: 1
          OMP_NUM_THREADS: 1
        run: ctest --test-dir $BUILD_DIR --output-on-failure --timeout 30 # 30 seconds per test

      - name: Verify example outputs (optional)
        continue-on-error: true
        run: |
          set -euxo pipefail
          if [ -f "scripts/compare_output.sh" ] && [ -f "examples/refOutput/ex1.txt" ]; then
            # Capture output for example 1
            ${{ env.BUILD_DIR }}/hypredrive examples/ex1.yml > ${{ env.BUILD_DIR }}/test_ex1_output.txt 2>&1 || true
            if [ -f "${{ env.BUILD_DIR }}/test_ex1_output.txt" ]; then
              bash scripts/compare_output.sh ${{ env.BUILD_DIR }}/test_ex1_output.txt examples/refOutput/ex1.txt || true
            fi
          fi

      - name: Cache ccache (Ubuntu)
        if: startsWith(runner.os, 'Linux')
        uses: hendrikmuhs/ccache-action@v1

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: logs-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ matrix.hypre_version }}
          path: |
            ${{ env.BUILD_DIR }}/Testing
            ${{ env.BUILD_DIR }}/CMakeFiles/CMakeOutput.log
            ${{ env.BUILD_DIR }}/CMakeFiles/CMakeError.log

      - name: Upload example outputs (optional)
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: example-outputs-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ matrix.hypre_version }}
          path: |
            ${{ env.BUILD_DIR }}/test_ex1_output.txt
          retention-days: 1

  autotools-build-and-test:
    if: ${{ github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'Run CI') }}
    name: ubuntu-latest | autotools
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      HYPRE_VERSION: master
      HYPRE_COMPILER: gcc
      HYPRE_BUILD_TYPE: Debug
      HYPRE_LIBTYPE: shared
      HYPRE_MIXEDINT: OFF
      HYPRE_OS: ubuntu-latest
      HYPRE_MPI_FLAVOR: openmpi
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool m4 make \
            libopenmpi-dev openmpi-bin gcc g++

      - name: Restore HYPRE cache
        id: hypre-cache
        uses: actions/cache@v5
        with:
          path: ${{ runner.tool_cache }}/hypre/${{ env.HYPRE_VERSION }}
          key: hypre-${{ env.HYPRE_VERSION }}-${{ env.HYPRE_OS }}-${{ env.HYPRE_COMPILER }}-${{ env.HYPRE_BUILD_TYPE }}-${{ env.HYPRE_LIBTYPE }}-mixedint-${{ env.HYPRE_MIXEDINT }}-${{ env.HYPRE_MPI_FLAVOR }}

      - name: Build HYPRE (cache miss)
        if: steps.hypre-cache.outputs.cache-hit != 'true'
        id: build-hypre
        uses: ./.github/actions/build-hypre
        with:
          hypre_version: ${{ env.HYPRE_VERSION }}
          compiler: ${{ env.HYPRE_COMPILER }}
          build_type: ${{ env.HYPRE_BUILD_TYPE }}
          hypre_shared_libs: 'ON'
          hypre_mixedint: ${{ env.HYPRE_MIXEDINT }}
          os: ubuntu-latest
          mpi_flavor: ${{ env.HYPRE_MPI_FLAVOR }}

      - name: Build and test (autotools)
        run: |
          set -euxo pipefail
          HYPRE_DIR="${{ runner.tool_cache }}/hypre/${{ env.HYPRE_VERSION }}"
          autoreconf -iv
          ./configure --with-hypre-dir="${HYPRE_DIR}" \
                      --prefix="$(pwd)/install-autotools"
          make -j
          OMPI_ALLOW_RUN_AS_ROOT=1 \
          OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1 \
          OMPI_MCA_btl_vader_single_copy_mechanism=none \
          OMPI_MCA_rmaps_base_oversubscribe=1 \
          OMP_NUM_THREADS=1 \
          make check
          make install

  build-and-test-caliper:
    if: ${{ github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'Run CI') }}
    name: ubuntu-latest | gcc | Caliper+Debug
    runs-on: ubuntu-latest
    timeout-minutes: 6
    env:
      HYPRE_VERSION: master
      BUILD_DIR: build-caliper
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libopenmpi-dev openmpi-bin ccache gcc g++ make

      - name: Setup compiler environment
        run: |
          export OMPI_CC=gcc
          export OMPI_CXX=g++
          echo "OMPI_CC=gcc" >> $GITHUB_ENV
          echo "OMPI_CXX=g++" >> $GITHUB_ENV

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ runner.os }}-caliper-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-caliper-

      - name: Cache datasets
        uses: actions/cache@v5
        with:
          path: data
          key: datasets-v1
          restore-keys: |
            datasets-v1

      - name: Configure hypredrive with Caliper
        run: |
          set -euxo pipefail
          cmake -S . -B $BUILD_DIR \
            -DCMAKE_BUILD_TYPE=Debug \
            -DHYPREDRV_ENABLE_CALIPER=ON \
            -DHYPREDRV_ENABLE_TESTING=ON \
            -DHYPREDRV_ENABLE_EXAMPLES=ON \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build $BUILD_DIR --parallel

      - name: Fetch datasets (optional)
        run: |
          set -euxo pipefail
          # Only download if datasets are not already cached
          if [ ! -d "data/ps3d10pt7" ] || [ -z "$(ls -A data/ps3d10pt7 2>/dev/null)" ]; then
            cmake --build $BUILD_DIR --target data --parallel
          else
            echo "Datasets already cached, skipping download"
          fi

      - name: Run make check with Caliper
        timeout-minutes: 5
        env:
          # OpenMPI configuration for CI
          OMPI_ALLOW_RUN_AS_ROOT: 1
          OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
          OMPI_MCA_btl_vader_single_copy_mechanism: none
          OMPI_MCA_rmaps_base_oversubscribe: 1
          OMP_NUM_THREADS: 1
          # Caliper configuration
          CALI_CONFIG: runtime-report
        run: |
          set -euxo pipefail
          # Run make check with Caliper enabled
          cd $BUILD_DIR
          make check
          # Verify Caliper output is generated (check for runtime-report output in stdout/stderr)
          echo "Checking for Caliper output..."
          # Caliper runtime-report outputs to stdout, so it should be visible in the logs

      - name: Cache ccache
        uses: hendrikmuhs/ccache-action@v1

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: logs-caliper
          path: |
            ${{ env.BUILD_DIR }}/Testing
            ${{ env.BUILD_DIR }}/CMakeFiles/CMakeOutput.log
            ${{ env.BUILD_DIR }}/CMakeFiles/CMakeError.log

  build-and-test-mixedint:
    if: ${{ github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'Run CI') }}
    name: ubuntu-latest | gcc | mixedint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      HYPRE_VERSION: master
      BUILD_DIR: build-mixedint
    steps:
      - uses: actions/checkout@v5

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libopenmpi-dev openmpi-bin ccache gcc g++ clang-format

      - name: Setup compiler environment
        run: |
          export OMPI_CC=gcc
          export OMPI_CXX=g++
          echo "OMPI_CC=gcc" >> $GITHUB_ENV
          echo "OMPI_CXX=g++" >> $GITHUB_ENV

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ runner.os }}-mixedint-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-mixedint-

      - name: Cache datasets
        uses: actions/cache@v4
        with:
          path: data
          key: datasets-v1
          restore-keys: |
            datasets-v1

      - name: Build HYPRE (mixedint)
        id: build-hypre
        uses: ./.github/actions/build-hypre
        with:
          hypre_version: ${{ env.HYPRE_VERSION }}
          compiler: gcc
          build_type: 'Debug'
          hypre_shared_libs: 'ON'
          hypre_mixedint: 'ON'
          os: ubuntu-latest

      - name: Configure hypredrive (mixedint)
        run: |
          set -euxo pipefail
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DHYPREDRV_ENABLE_TESTING=ON -DHYPREDRV_ENABLE_EXAMPLES=ON \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_PREFIX_PATH=${{ steps.build-hypre.outputs.hypre_prefix }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build $BUILD_DIR --parallel

      - name: Fetch datasets (optional)
        run: |
          set -euxo pipefail
          if [ ! -d "data/ps3d10pt7" ] || [ -z "$(ls -A data/ps3d10pt7 2>/dev/null)" ]; then
            cmake --build $BUILD_DIR --target data --parallel
          else
            echo "Datasets already cached, skipping download"
          fi

      - name: Run tests
        timeout-minutes: 5
        env:
          OMPI_ALLOW_RUN_AS_ROOT: 1
          OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
          OMPI_MCA_btl_vader_single_copy_mechanism: none
          OMPI_MCA_rmaps_base_oversubscribe: 1
          OMP_NUM_THREADS: 1
        run: ctest --test-dir $BUILD_DIR --output-on-failure --timeout 30
