name: Static Analysis

on:
  pull_request:
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'NOTICE'
      - 'COPYRIGHT'
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'NOTICE'
      - 'COPYRIGHT'
  schedule:
    - cron: '0 3 * * 0' # Runs at 03:00 UTC every Sunday
  workflow_dispatch:    # Allow manual triggering

concurrency:
  group: analysis-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cppcheck:
    name: cppcheck
    runs-on: ubuntu-latest
    env:
      HYPRE_VERSION: master
      BUILD_DIR: build-analysis
    steps:
      - uses: actions/checkout@v5

      - name: Setup Ubuntu environment
        uses: ./.github/actions/setup-ubuntu
        with:
          compiler: 'gcc'
          extra_packages: 'cppcheck'

      - name: Build HYPRE
        id: build-hypre
        uses: ./.github/actions/build-hypre
        with:
          hypre_version: ${{ env.HYPRE_VERSION }}
          compiler: 'gcc'
          build_type: 'Release'
          hypre_shared_libs: 'ON'

      - name: Configure hypredrive
        run: |
          set -euxo pipefail
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DHYPREDRV_ENABLE_CODE_ANALYSIS=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_C_COMPILER=mpicc \
            -DCMAKE_PREFIX_PATH=${{ steps.build-hypre.outputs.hypre_prefix }}

      - name: Build
        run: cmake --build $BUILD_DIR --parallel

      - name: Run cppcheck
        run: cmake --build $BUILD_DIR --target cppcheck
        continue-on-error: true

      - name: Upload cppcheck report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: cppcheck-report
          path: ${{ env.BUILD_DIR }}/cppcheck-report.html
          retention-days: 7

  clang-tidy:
    name: clang-tidy
    runs-on: ubuntu-latest
    env:
      HYPRE_VERSION: master
      BUILD_DIR: build-analysis
    steps:
      - uses: actions/checkout@v5

      - name: Setup Ubuntu environment
        uses: ./.github/actions/setup-ubuntu
        with:
          compiler: 'clang'
          extra_packages: 'clang-tidy'

      - name: Build HYPRE
        id: build-hypre
        uses: ./.github/actions/build-hypre
        with:
          hypre_version: ${{ env.HYPRE_VERSION }}
          compiler: 'clang'
          build_type: 'Release'
          hypre_shared_libs: 'ON'

      - name: Configure hypredrive
        run: |
          set -euxo pipefail
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DHYPREDRV_ENABLE_CODE_ANALYSIS=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_C_COMPILER=mpicc \
            -DCMAKE_PREFIX_PATH=${{ steps.build-hypre.outputs.hypre_prefix }}

      - name: Build
        run: cmake --build $BUILD_DIR --parallel

      - name: Run clang-tidy
        run: cmake --build $BUILD_DIR --target clang-tidy
        continue-on-error: true

      - name: Upload clang-tidy report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: clang-tidy-report
          path: ${{ env.BUILD_DIR }}/clang-tidy-output.txt
          retention-days: 7

